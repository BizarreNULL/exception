<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Jojo's Exceptions</title><link>https://exception.blog/</link><description>Recent content on Jojo's Exceptions</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><lastBuildDate>Tue, 06 Jul 2021 23:38:32 -0300</lastBuildDate><atom:link href="https://exception.blog/index.xml" rel="self" type="application/rss+xml"/><item><title>Interagir em enquetes abertas no LinkedIn √© uma p√©ssima ideia!</title><link>https://exception.blog/posts/interagir-em-enquetes-no-linkedin-e-uma-pessima-ideia/</link><pubDate>Sun, 14 Mar 2021 15:31:10 -0300</pubDate><guid>https://exception.blog/posts/interagir-em-enquetes-no-linkedin-e-uma-pessima-ideia/</guid><description>Diversas vezes me deparo na rede social voltada para trabalho (uma nota pessoal sobre, politica nacional, tem muito haver com o nosso trabalho), inumeras enquetes no estilo interaja com determinada a√ß√£o, para exibir qual a sua op√ß√£o dentre as poss√≠veis enumeradas em determinada postagem, que s√£o um prato cheio para o pessoal que gosta de analisar perfils, ou de intelig√™ncia. Atualmente, isso vem se popularizando muito, por conta de cada vez mais atritos entre o Bolsonaro, com o retorno oficial de Lula √† cena deplor√°vel da politica brasileira.</description><content>&lt;p>Diversas vezes me deparo na rede social &lt;em>voltada para trabalho&lt;/em> (uma nota pessoal sobre, politica nacional, tem &lt;strong>muito&lt;/strong> haver com o nosso trabalho), inumeras enquetes no estilo interaja com determinada a√ß√£o, para exibir qual a sua op√ß√£o dentre as poss√≠veis enumeradas em determinada postagem, que s√£o um prato cheio para o pessoal que gosta de analisar perfils, ou de intelig√™ncia. Atualmente, isso vem se popularizando muito, por conta de cada vez mais atritos entre o Bolsonaro, com o retorno oficial de Lula √† cena deplor√°vel da politica brasileira.&lt;/p>
&lt;blockquote>
&lt;p>&lt;strong>Nota&lt;/strong>: N√£o gosto de ambos os poss√≠veis presidenci√°veis de 2022, mas assumo que repudio o descaso do atual presidente a cena que vivemos na pandemia, bem como a falta de transpar√™ncia do presidente rival em entregar mais clareza dos fatos pessoais de seus julgamentos. Mas pela v√°rzea que vivemos, acredito que n√£o preciso explicar minha opini√£o para essas duas figuras.&lt;/p>
&lt;/blockquote>
&lt;p>Antes de mais nada, acredito que qualquer fluxo de tratamento de dados que possa ser especializado sem muito esfor√ßo por uma parte, sempre vai ser uma p√©ssima a√ß√£o, qualquer tipo de intera√ß√£o com essas entidades. Afinal de contas, a rede da Microsoft j√° tem acesso a todos os nossos padr√µes de comportamento, e a √∫nica ressalva que temos √© as politicas e leis de prote√ß√£o aos dados pessoais (que parece valer menos caso voc√™ for um utilizador chin√™s na plataforma, ou n√£o for um cidad√£o de mesma nacionalidade da plataforma, mas esses casos de conflitos de interesses entre ocidente e oriente, bem como os pr√≥prios interesses do LinkedIn, fica para outra postagem).&lt;/p>
&lt;p>Como o LinkedIn √© uma rede que tende a ser aberta para quem tem vinc√∫lo com a pessoa &lt;code>X&lt;/code> ou &lt;code>Y&lt;/code>, n√£o esperem de mim censurar os nomes e perfils, bem como o resultado dessa an√°lise. Para ficar com o de costume, caso encontrar seus dados aqui na minha an√°lise, e precisar esconde-los daqui, basta abrir uma &lt;em>issue&lt;/em> ou uma &lt;em>pull request&lt;/em> no blog, atrav√©s de seu reposit√≥rio no GitHub.&lt;/p>
&lt;h1 id="enfim-coisas-t√©cnicas">Enfim coisas t√©cnicas&lt;/h1>
&lt;p>Fui para o caminho mais r√°pido poss√≠vel para isso, poderia ter analisado o aplicativo ou tentado encontrar algo j√° pronto para essa finalidade, mas acredito que a divers√£o de trabalhar com escopos de an√°lise de dados em plataformas que n√£o disp√µe com clareza formas de interagir com os dados ali presentes, um desafio simples, mas muito produtivo no aspecto de mapear perfils em redes sociais, seja ela do tipo que for.&lt;/p>
&lt;p>Como de praste, minha &lt;em>stack&lt;/em> de desenvolvimento vai ser o C# 9, junto do .NET5 (em breve pretendo mudar o &lt;em>target&lt;/em> para quando a &lt;em>preview&lt;/em> 3 do .NET6 estiver dispon√≠vel, especialmente para brincar no Apple Silicon, e tamb√©m explorar mais a MAUI, al√©m de n√£o ter problemas com a RFC do &lt;em>float&lt;/em>). Para o &lt;em>parsing&lt;/em> da sopinha de &lt;em>tags&lt;/em> do HTML, vou tentar uma approach o mais &lt;em>vanilla&lt;/em> poss√≠vel, utilizando &lt;code>IndexOf()&lt;/code>, &lt;code>Remove()&lt;/code> e fun√ß√µes nativas da linguagem, para garantir uma performance consistente, sem adicionar bibliotecas complexas para uma finalidade muito simples.&lt;/p>
&lt;h3 id="analisando-a-requisi√ß√£o-de-uma-postagem">Analisando a requisi√ß√£o de uma postagem&lt;/h3>
&lt;p>A primeira coisa que vou fazer (estou escrevendo enquanto vou descobrindo a melhor forma de fazer isso acontecer, ent√£o caso queira apenas o resultado final, v√° direto ao reposit√≥rio refer√™nciado no final da postagem) √© analisar a aba &lt;em>network&lt;/em> do navegador, ao interagir com uma postagem:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">curl &lt;span style="color:#e6db74">&amp;#39;https://www.linkedin.com/voyager/api/feed/reactions?count=10&amp;amp;q=reactionType&amp;amp;start=70&amp;amp;threadUrn=urn:li:activity:XXXXX614171169XXXXX&amp;#39;&lt;/span> &lt;span style="color:#ae81ff">\
&lt;/span>&lt;span style="color:#ae81ff">&lt;/span> -H &lt;span style="color:#e6db74">&amp;#39;...&amp;#39;&lt;/span> &lt;span style="color:#ae81ff">\
&lt;/span>&lt;span style="color:#ae81ff">&lt;/span> --compressed
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Realmente esperei que seria algo mais complexo, mas o LinkedIn facilita bastante, j√° que sua API RESTful fornece o &lt;em>endpoint&lt;/em> &lt;code>reactions&lt;/code> de f√°cil acesso a qualquer usu√°rio, claro que no cabe√ßalho da requisi√ßao, existia minha sess√£o, que por motivos √≥bvios, acabei removendo-a para evitar problemas com os amigos &lt;em>h4x05s&lt;/em>.&lt;/p>
&lt;p>Al√©m disso, os par√¢metros de pagina√ß√£o, &lt;code>start&lt;/code> e &lt;code>count&lt;/code> v√£o facilitar bastante na hora de realizar as requisi√ß√µes de fato! Da forma facilitada que estamos vendo, acredito que uma alternativa 100% v√°lida seria utilizar somente ShellScript junto do &lt;code>jq&lt;/code>, acabaria por resolver esse primeiro ponto. Mas como quero fazer algo com um pouco mais de fun√ß√µes, vou prosseguir com a ideia do C#, e pelo visto, nem ser√° necess√°rio quebrar a cabe√ßa com o &lt;em>parsing&lt;/em> de qualquer trecho da p√°gina.&lt;/p>
&lt;p>Expondo o &lt;em>dataset&lt;/em> que vou consumir, ser√° &lt;a href="https://www.linkedin.com/posts/wanderson-santos-136a1bb0_e-a%C3%AD-o-que-ser%C3%A1-de-n%C3%B3s-activity-6775961417116983296-2aR0/">essa postagem&lt;/a>.&lt;/p>
&lt;p>Com tantas informa√ß√µes j√° dispon√≠veis, vamos codificar um pouco! Gra√ßas ao &lt;code>record&lt;/code> do C# 9, abstrair esses modelos de dados ficaram muito simples, e extremamente perform√°ticos:&lt;/p>
&lt;p>&lt;img src="https://exception.blog/static/image-20210314164216249.png" alt="A foto do progresso!">&lt;/p>
&lt;p>Evoluindo para um melhor entendimento da resposta vinda da API, que n√£o √© t√£o f√°cil de entender a primeiro momento, mas depois fica bem tranquilo de entender (existe formas bem mais ficientes de ser implementado o &lt;em>parsing&lt;/em>):&lt;/p>
&lt;p>&lt;img src="https://exception.blog/static/image-20210314174239109.png" alt="Enumerando usu√°rios paginados na requisi√ß√£o">&lt;/p>
&lt;p>Depois de continuar evoluindo o c√≥digo para respeitar (parcialmente) a pagina√ß√£o, e entendendo melhor como funciona o comportamento dos servidores do LinkedIn, em especial, sobre &lt;em>rate limiting&lt;/em>, foi s√≥ uma quest√£o de escrever um c√≥digo XGH para extrair todo o conte√∫do, e indexa-lo em um arquivo &lt;code>.csv&lt;/code> para uma an√°lise mais profunda:&lt;/p>
&lt;p>&lt;img src="https://exception.blog/static/image-20210314200041144.png" alt="O dataset formado">&lt;/p>
&lt;p>Para simpliificar, e n√£o fazer diversas requisi√ß√µes ao &lt;em>backend&lt;/em> do LinkedIn, escolhi aleat√≥riamente 1064 pessoas daquela postagem. Por fim o c√≥digo em C# ficou uma bagun√ßa, mas cumpriu seu prop√≥sito de forma majestosa, indexando todos esses resultados em apenas alguns segundos - tudo isso pode ser parametrizado atrav√©s dos par√¢metros da pr√≥pria API da rede social.&lt;/p>
&lt;p>Um ponto de aten√ß√£o, √© sobre os &lt;em>cookies&lt;/em> necess√°rios para estar autenticado, e tamb√©m, autorizado dentro do LinkedIn:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-csharp" data-lang="csharp">&lt;span style="color:#66d9ef">var&lt;/span> session = &lt;span style="color:#66d9ef">new&lt;/span> CookieContainer();
session.Add(&lt;span style="color:#66d9ef">new&lt;/span> Cookie(&lt;span style="color:#e6db74">&amp;#34;JSESSIONID&amp;#34;&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;...&amp;#34;&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;/&amp;#34;&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;.www.linkedin.com&amp;#34;&lt;/span>));
session.Add(&lt;span style="color:#66d9ef">new&lt;/span> Cookie(&lt;span style="color:#e6db74">&amp;#34;li_at&amp;#34;&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;...&amp;#34;&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;/&amp;#34;&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;.www.linkedin.com&amp;#34;&lt;/span>));
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Todos os demais &lt;em>cookies&lt;/em> s√£o apenas &lt;em>trackers&lt;/em> ou caso voc√™ utilize um provedor de SSO. Para os &lt;em>headers&lt;/em>, para minha surpresa, s√≥ √© necess√°rio o seguinte:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-csharp" data-lang="csharp">&lt;span style="color:#66d9ef">var&lt;/span> reactionsMessage = &lt;span style="color:#66d9ef">new&lt;/span> HttpRequestMessage(HttpMethod.Get, post)
{
Headers =
{
{&lt;span style="color:#e6db74">&amp;#34;csrf-token&amp;#34;&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;...&amp;#34;&lt;/span>}
}
};
&lt;/code>&lt;/pre>&lt;/div>&lt;p>E claro, configurar adequadamente seu &lt;code>HttpClient&lt;/code> e &lt;code>HttpClientHandler&lt;/code>. Deixei os &lt;em>cookies&lt;/em> apontados para o objeto &lt;code>session&lt;/code>, do primeiro &lt;em>snippet&lt;/em> de c√≥digo, dessa forma ficou tudo bem organizado da seguinte forma:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-csharp" data-lang="csharp">&lt;span style="color:#66d9ef">using&lt;/span> var clientHandler = &lt;span style="color:#66d9ef">new&lt;/span> HttpClientHandler
{
UseCookies = &lt;span style="color:#66d9ef">true&lt;/span>,
AllowAutoRedirect = &lt;span style="color:#66d9ef">false&lt;/span>,
CookieContainer = session
};
&lt;span style="color:#66d9ef">using&lt;/span> var client = &lt;span style="color:#66d9ef">new&lt;/span> HttpClient(clientHandler);
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Depois de tudo isso, veio uma parte meia feia, no que se diz respeito as melhores pr√°ticas para nomear os tipos dentro do C#, isso acontece nessa vers√£o do .NET5 por conta da falta de suporte da &lt;em>annotation&lt;/em> &lt;code>JsonPropertyName&lt;/code>, de ser utilizada em &lt;code>record&lt;/code> e tamb√©m em seus construtores, ent√£o para simplificar o c√≥digo, abstrai apenas os elementos que foram importantes para essa an√°lise:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-csharp" data-lang="csharp">&lt;span style="color:#66d9ef">private&lt;/span> record Paging(&lt;span style="color:#66d9ef">int&lt;/span> start, &lt;span style="color:#66d9ef">int&lt;/span> total, &lt;span style="color:#66d9ef">int&lt;/span> count);
&lt;span style="color:#66d9ef">private&lt;/span> record description(&lt;span style="color:#66d9ef">string&lt;/span> text);
&lt;span style="color:#66d9ef">private&lt;/span> record name(&lt;span style="color:#66d9ef">string&lt;/span> text);
&lt;span style="color:#66d9ef">private&lt;/span> record Element(&lt;span style="color:#66d9ef">string&lt;/span> reactionType, description description, name name);
&lt;/code>&lt;/pre>&lt;/div>&lt;p>De certa forma ficou simples, por√©m dava para ter feito melhor. Com as limita√ß√µes da &lt;code>System.Text.Json&lt;/code>, acredito que por enquanto, esse seria o mais minificado que conseguiria chegar por enquanto. Para realizar o &lt;em>parsing&lt;/em> do JSON que √© respondido, fiz algo bem simples - mas sentindo muita falta da simplicidade de tratar tipos de forma din√¢mica, igual temos na NewtonSoftware, mas como sempre prefiro fazer sem utilizar nada al√©m da &lt;em>std&lt;/em>, acho que est√° de bom tamanho:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-csharp" data-lang="csharp">&lt;span style="color:#66d9ef">var&lt;/span> content = &lt;span style="color:#66d9ef">await&lt;/span> response.Content.ReadAsStringAsync();
&lt;span style="color:#66d9ef">var&lt;/span> payload = JsonSerializer.Deserialize&amp;lt;JsonElement&amp;gt;(content);
&lt;span style="color:#66d9ef">var&lt;/span> paging = JsonSerializer.Deserialize&amp;lt;Paging&amp;gt;(payload.GetProperty(&lt;span style="color:#e6db74">&amp;#34;paging&amp;#34;&lt;/span>).GetRawText());
&lt;span style="color:#66d9ef">if&lt;/span> (paging == &lt;span style="color:#66d9ef">null&lt;/span>) &lt;span style="color:#66d9ef">return&lt;/span>;
&lt;/code>&lt;/pre>&lt;/div>&lt;p>E dessa forma seguimos o &lt;em>parsing&lt;/em> para os demais &lt;code>record&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-c#" data-lang="c#">&lt;span style="color:#66d9ef">var&lt;/span> elements = JsonSerializer.Deserialize&amp;lt;List&amp;lt;Element&amp;gt;&amp;gt;(payload.GetProperty(&lt;span style="color:#e6db74">&amp;#34;elements&amp;#34;&lt;/span>).GetRawText());
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Na verdade todos eles est√£o referenciados explicitamente pelo &lt;code>Element&lt;/code>, dessa forma, basta iterar sobre a lista e colher os dados que julgar necess√°rio. No meu caso imprimi na tela, conforme nas primeiras imagens, para ter uma no√ß√£o de como as coisas estavam funcionando:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-c#" data-lang="c#">elements.ForEach(e =&amp;gt;
{
&lt;span style="color:#66d9ef">if&lt;/span> (e == &lt;span style="color:#66d9ef">null&lt;/span>) &lt;span style="color:#66d9ef">return&lt;/span>;
&lt;span style="color:#66d9ef">if&lt;/span> (e.name != &lt;span style="color:#66d9ef">null&lt;/span> &amp;amp;&amp;amp; !&lt;span style="color:#66d9ef">string&lt;/span>.IsNullOrEmpty(e.name.text))
{
Console.WriteLine(&lt;span style="color:#e6db74">$&amp;#34; &amp;gt; User: {e.name.text.ToUpperInvariant()}&amp;#34;&lt;/span>);
}
&lt;span style="color:#66d9ef">if&lt;/span> (e.description != &lt;span style="color:#66d9ef">null&lt;/span> &amp;amp;&amp;amp; !&lt;span style="color:#66d9ef">string&lt;/span>.IsNullOrEmpty(e.description.text))
{
Console.WriteLine(&lt;span style="color:#e6db74">$&amp;#34; &amp;gt; Role: {e.description.text.ToUpperInvariant()}&amp;#34;&lt;/span>);
}
&lt;span style="color:#66d9ef">if&lt;/span> (e.reactionType != &lt;span style="color:#66d9ef">null&lt;/span> &amp;amp;&amp;amp; !&lt;span style="color:#66d9ef">string&lt;/span>.IsNullOrEmpty(e.reactionType))
{
Console.WriteLine(&lt;span style="color:#e6db74">$&amp;#34; &amp;gt; Type: {e.reactionType}&amp;#34;&lt;/span>);
}
});
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Ainda que n√£o temos algo din√¢mico, as refer√™nciais internas dos &lt;code>record&lt;/code> ainda podem ser trai√ßoeiras se acessadas diretamente, como tentar navegar diretamente para &lt;code>e.name.text&lt;/code>, que pode resultar em uma refer√™ncia nula dentro do escopo de execu√ß√£o, por isso temos tamb√©m a valida√ß√£o de &lt;code>e.name != null&lt;/code>.&lt;/p>
&lt;p>Depois disso tudo, s√≥ utilizo um &lt;code>Distinct()&lt;/code> e indexo todo o resultado em um &lt;code>.csv&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-csharp" data-lang="csharp">&lt;span style="color:#66d9ef">await&lt;/span> File.WriteAllLinesAsync(&lt;span style="color:#e6db74">&amp;#34;result.csv&amp;#34;&lt;/span>, textToWrite.Distinct().ToList());
&lt;/code>&lt;/pre>&lt;/div>&lt;p>E tudo isso vai ter como produto, o que vamos utilizar para analisar de forma mais profunda os dados, de quem gosta mais de &lt;code>X&lt;/code> ou &lt;code>Y&lt;/code>.&lt;/p>
&lt;h1 id="quem-√©-quem">Quem √© quem?&lt;/h1>
&lt;p>Vamos analisar brevemente os dados produzidos. Para simplificar, realizei a convers√£o desse &lt;code>.csv&lt;/code> para um &lt;code>.sqlite&lt;/code> (poderia ter utilizado algo mais simples com &lt;code>pandas&lt;/code>) e consumindo os resultados pela pr√≥pria &lt;em>shell&lt;/em> do &lt;code>sqlite3&lt;/code>:&lt;/p>
&lt;pre>&lt;code class="language-sqlite" data-lang="sqlite">sqlite&amp;gt; .schema
CREATE TABLE CRAW(
&amp;quot;NAME&amp;quot; TEXT,
&amp;quot;ROLE&amp;quot; TEXT,
&amp;quot;REACTION&amp;quot; TEXT
);
sqlite&amp;gt; SELECT COUNT() FROM CRAW;
1064
&lt;/code>&lt;/pre>&lt;p>Para a postagem que utilizei como refer√™ncia, temos:&lt;/p>
&lt;ul>
&lt;li>√Ä favor do Bolsonaro: Quem possivelmente teve sua rea√ß√£o como sendo &lt;code>LIKE&lt;/code>;&lt;/li>
&lt;li>√Ä favor do Lula: Quem poss√≠velmente teve sua rea√ß√£o como sendo &lt;code>EMPATHY&lt;/code>.&lt;/li>
&lt;/ul>
&lt;p>Com isso em pauta, vamos olhar a quantidade de pessoas que votaram em cada uma das figuras pol√≠ticas:&lt;/p>
&lt;pre>&lt;code class="language-sqlite" data-lang="sqlite">sqlite&amp;gt; SELECT COUNT() FROM CRAW WHERE REACTION = &amp;quot;EMPATHY&amp;quot;;
319
sqlite&amp;gt; SELECT COUNT() FROM CRAW WHERE REACTION = &amp;quot;LIKE&amp;quot;;
668
&lt;/code>&lt;/pre>&lt;p>Nesse &lt;em>dataset&lt;/em> que colhi da postagem, chegamos ao total de 319 votos √† favor do Lula, e 668 votos para o Bolsonaro. Por√©m, da mesma forma que podemos apenas realizar um &lt;code>COUNT()&lt;/code>, tamb√©m podemos olhar apenas para os nomes de quem poss√≠velmente prefere governo &lt;code>X&lt;/code> ou &lt;code>Y&lt;/code>, come√ßando pelo candidato de direita:&lt;/p>
&lt;pre>&lt;code class="language-sqlite" data-lang="sqlite">sqlite&amp;gt; SELECT NAME FROM CRAW WHERE REACTION = &amp;quot;LIKE&amp;quot; LIMIT 10;
NADINE JUNKES
MATHEUS CHAGAS
BRUNO JARED CRUZ
JO√ÉO GANDOLFI
URIEL OLIVEIRA BEZERRA
ADONAI DUTRA
CARLOS EVERTON DOS SANTOS GERALDO
JEFFERSON J.
SARA ELAINE LOPES PEREIRA
M√ÅRCIO ROSA
&lt;/code>&lt;/pre>&lt;p>E por fim, Lula:&lt;/p>
&lt;pre>&lt;code class="language-sqlite" data-lang="sqlite">sqlite&amp;gt; SELECT NAME FROM CRAW WHERE REACTION = &amp;quot;EMPATHY&amp;quot; LIMIT 10;
ANA CEC√çLIA MACHADO
GIOVANNA DUARTE ALMEIDA
LUCAS CATTA PR√äTA
SHEILA PATRICIO
DANIEL TOMAZELLI RAMOS
CRISTIANO FERREIRA
SUELLEN CAROLINE
SABRINA BECKER
VINICIUS T.
VICT√ìRIA LAPENNA RODRIGUES
&lt;/code>&lt;/pre>&lt;p>Tamb√©m podemos analisar os cargos de cada um, e correlaciona-los com o poss√≠vel ideal pol√≠tico base de dada um. Da mesma forma, podemos utilizar essa mesma an√°lise para determinar o cunho pol√≠tico de uma empresa, marca ou qualquer p√°gina no LinkedIn que fique atrelada a uma pessoa.&lt;/p>
&lt;h1 id="conclus√£o">Conclus√£o&lt;/h1>
&lt;p>Em poucos minutos (na verdade foi um intervalo de algumas horas, domingo √© dia de arrumar a casa, e meus gatos conseguiram se superar essa semana), vimos a possibilidade de escrever um &lt;em>crawler&lt;/em> muito simples para an√°lisar uma postagem relacionada a uma &lt;em>poll&lt;/em> baseada em rea√ß√µes, e chegar em cada um dos perfils que reagiram individualmente.&lt;/p>
&lt;p>Lembre-se que fiz isso sem buscar qualquer resultado ou benef√≠cio disso, mas sabemos que existem centenas de empresas que fazem diferente. Da mesma forma, imagine a quantidade de empresas que poss√≠velmente te barrou em um processo seletivo, por analisar rapidamente seu perfil com alguma dessas ferramentas, e verificou que seu ideal pol√≠tico, ou seja l√° qual for os dados que a empresa estiver analisando, n√£o est√° de acordo com ela.&lt;/p>
&lt;p>No final do dia, todos n√≥s somos dados, n√∫meros e m√©tricas. Dentro do LinkedIn, especialmente pelo fato de existir uma concep√ß√£o ou id√©ia de que todos somos aut√™nticos (no sentido de n√£o ter uma grande concentra√ß√£o de perfils de identidade incertas, ou &lt;em>fakes&lt;/em> de outras pessoas), isso se torna &lt;strong>muito&lt;/strong> mais perigoso. Ent√£o tenha mais cuidado ao interagir com esse tipo de informa√ß√£o, seus dados podem estar nesse momento passando na m√£o da empresa que voc√™ acabou de aplicar.&lt;/p>
&lt;blockquote>
&lt;p>&lt;strong>Nota&lt;/strong>: Ao ver que ainda existem pessoas que carregam pol√≠ticos de estima√ß√£o, vejo que 2022 vai ser um ano muito complicado. Tamb√©m aproveito o momento para repetir: Por mim ambas as figuras presidenci√°veis s√£o, no m√≠nimo, rid√≠culas.&lt;/p>
&lt;/blockquote></content></item><item><title>Hackeando apps financeiros para OSINT (e pela zueira): Tudo pelo PIX!</title><link>https://exception.blog/posts/hackeando-apps-financeiros-para-osint/</link><pubDate>Sun, 10 Jan 2021 16:47:21 -0300</pubDate><guid>https://exception.blog/posts/hackeando-apps-financeiros-para-osint/</guid><description>O PIX foi uma das maiores mudan√ßas que tivemos promovidas pelo BACEN (e por outras institui√ß√µes financeiras ligadas aos f√≥runs), que vai promover muita agilidade, simplicidade, e o mais importante seguran√ßa. Um dos pontos mais perigosos de vender um produto, ou uma feature dele como sendo algo seguro, √© que muitas vezes isso pode ser utilizado contra voc√™.
Para n√£o focarmos no PIX, e ir direto ao assunto, deixo como recomenda√ß√£o uma postagem feita pelo mestre Anchises l√° no blog do posto Ipiranga, voc√™ pode encontra-l√° aqui, recomendo que fa√ßa a leitura do conte√∫do, antes de avan√ßar por aqui.</description><content>&lt;p>O PIX foi uma das maiores mudan√ßas que tivemos promovidas pelo BACEN (e por outras institui√ß√µes financeiras ligadas aos f√≥runs), que vai promover muita agilidade, simplicidade, e o mais importante seguran√ßa. Um dos pontos mais perigosos de vender um produto, ou uma &lt;em>feature&lt;/em> dele como sendo algo seguro, √© que muitas vezes isso pode ser utilizado contra voc√™.&lt;/p>
&lt;p>Para n√£o focarmos no PIX, e ir direto ao assunto, deixo como recomenda√ß√£o uma postagem feita pelo mestre Anchises l√° no &lt;em>blog do posto Ipiranga&lt;/em>, voc√™ pode encontra-l√° &lt;a href="https://anchisesbr.blogspot.com/2020/10/seguranca-aspectos-de-seguranca-do-pix.html">aqui&lt;/a>, recomendo que fa√ßa a leitura do conte√∫do, antes de avan√ßar por aqui.&lt;/p>
&lt;p>Antes de cairmos em cima do banco, ou &lt;em>fintech&lt;/em> que escolhi para efetuar o &lt;em>bypassing&lt;/em> de todas as funcionalidades de seguran√ßa da aplica√ß√£o - ofusca√ß√£o de payloads n√£o √© bala de prata, uma dica importante - vou trazer um trecho do pr√≥prio Anchises da sua postagem em seu blog:&lt;/p>
&lt;blockquote>
&lt;p>&lt;a href="https://www.bcb.gov.br/estabilidadefinanceira/pagamentosinstantaneos">Segundo o Banco Central&lt;/a>, o objetivo √© oferecer pagamento instant√¢neo seja t√£o f√°cil, simples, intuitiva e r√°pida quanto realizar um pagamento com dinheiro em esp√©cie. Os pagadores poder√£o iniciar pagamentos usando chaves ou apelidos para a identifica√ß√£o da conta transacional como o n√∫mero do telefone celular, o CPF, o CNPJ ou um endere√ßo de e-mail (que devem ser cadastrados no seu banco), por meio de QR Code (est√°tico ou din√¢mico) ou com uso da tecnologia NFC (near-field communication) para pagamentos por aproxima√ß√£o.&lt;/p>
&lt;/blockquote>
&lt;p>√â importante notarmos esses itens relacionados a como a chave pode ser formada, bem como as informa√ß√µes que s√£o contidas nela. Sua chave PIX, pode ser seu &lt;strong>telefone celular&lt;/strong>, &lt;strong>CPF&lt;/strong>, &lt;strong>CNPJ&lt;/strong>, &lt;strong>endere√ßo de e-mail&lt;/strong> ou uma chave gerada &amp;ldquo;aleatoriamente&amp;rdquo; e vinculada a sua conta.&lt;/p>
&lt;p>Quando algu√©m realiza uma transfer√™ncia de valores utilizando o PIX, temos um &lt;code>whois&lt;/code> de quem est√° por de tr√°s daquela chave, trazendo informa√ß√µes como &lt;strong>nome completo&lt;/strong>, &lt;strong>CPF mascarado&lt;/strong> (na verdade alguns bancos esqueceram dessa parte para clientes da mesma institui√ß√£o, como sempre, o OSINT agradece, mas acredito que n√£o deveria funcionar dessa forma üëÄ, ou muitas vezes vazando o n√∫mero do documento consultando o comprovante de pagamento, que n√£o trazia esse dado para o cliente &lt;em>mobile&lt;/em>) e o &lt;strong>banco do destinat√°rio&lt;/strong>.&lt;/p>
&lt;p>Alguns cen√°rios que podemos mapear fazendo uma an√°lise dessa superf√≠cie de ataque, s√£o relativamente pequenos, como encontrar o nome completo de uma pessoa que cadastrou um e-mail como sua chave. Por√©m para dentro da cena de OSINT, esse √© um recurso muito poderoso, especialmente pelas tratativas das famosas pessoas publicamente expostas, j√° que agora √© poss√≠vel chegar no banco que um pol√≠tico ou milion√°rio guarda sua grana (e tamb√©m seus &lt;em>offshores&lt;/em>, caso for uma institui√ß√£o nacional).&lt;/p>
&lt;p>Outro ponto muito interessante que podemos explorar, al√©m de enumerar massivamente chaves PIX, enriquecendo cada vez mais uma lista de e-mails, ou de &lt;em>phishing&lt;/em>, √© utilizar-se da fun√ß√£o de transferir R$ 0,01 centavos (durante minhas an√°lises, algumas &lt;em>fintechs&lt;/em> me permitiram inclusive adicionar dinheiro que n√£o existia, tipos fortes s√£o seus amigos, n√£o deixe passar &lt;code>float&lt;/code>, &lt;code>double&lt;/code> e &lt;code>decimal&lt;/code> como a mesma coisa em sua &lt;em>stack&lt;/em>), com o b√≥nus de conter uma mensagem com &lt;strong>qualquer conte√∫do&lt;/strong>, e bom, isso √© perigoso em diversas formas.&lt;/p>
&lt;blockquote>
&lt;p>Isso inclusive virou meme, e gra√ßas a esse meme das mensagens cornas via PIX, que surgiu a maliciosidade nos olhos da galera, para montar campanhas de &lt;em>marketing&lt;/em> totalmente direcionadas, pela bagatela de um centavo a mensagem.&lt;/p>
&lt;/blockquote>
&lt;h1 id="o-escolhido-depois-de-uma-longa-an√°lise-de-outros-candidatos">O escolhido (depois de uma longa an√°lise de outros candidatos)&lt;/h1>
&lt;p>Depois de olhar alguns dos principais meios de pagamento que tinham implementado o PIX, acabei por selecionar uma aplica√ß√£o Android muito bem escrita para utilizar nos testes (principalmente pois j√° tinha uma conta aberta l√°, que nunca utilizei), foi bom para relembrar muita coisa das magias ocultas que um bom framework de instrumenta√ß√£o pode fazer, nesse caso utilizei o vov√¥ XPOSED, e depois acabei migrando para o Frida j√° que n√£o precisava trocar nada na ROM padr√£o do AVD.&lt;/p>
&lt;p>Essa aplica√ß√£o em especial, me chamou bastante aten√ß√£o na forma que foi implementado os recursos de seguran√ßa, mas um pequeno deslize por parte dos desenvolvedores, permitiram que todas as suas funcionalidades fossem facilmente (na verdade eu levei 5 horas olhando SMALI e umas chamadas malucas do JNI) ignoradas por um famoso &lt;code>try {} catch {}&lt;/code> implementado de forma gen√©rica.&lt;/p>
&lt;p>Como j√° dizia o ditado, de nada adianta pagar milh√µes para GuardSquare para deixar seus execut√°veis devidamente ofuscados, sendo que o &amp;ldquo;feij√£o com arroz&amp;rdquo; do &lt;em>clean code&lt;/em> n√£o √© colocado quando a esteira de desenvolvimento ferve. Na verdade encontrei esse mesmo detalhe em outras aplica√ß√µes nacionais.&lt;/p>
&lt;p>Nessa mesma aplica√ß√£o, notei tamb√©m a falta de sanitiza√ß√£o dessa mensagem do PIX, e acabei por escrever um fuzzer para tentar pegar alguma coisa na renderiza√ß√£o da mensagem, talvez traga esse item em outra postagem. Enfim, continuando a an√°lise, percebi que o &lt;em>bypass&lt;/em> rolou, gra√ßas a forma que essas fun√ß√µes de seguran√ßa eram implementadas: Havia uma &lt;em>activity&lt;/em> principal, que era executada antes de todas as outras (no come√ßo parecia uma gambiarra, depois parecia que estava no come√ßo), e quando era feito esse &lt;em>handling&lt;/em> dos estados das telas da aplica√ß√£o, quando essa principal era instanciada, as verifica√ß√µes de seguran√ßa, eram realizadas.&lt;/p>
&lt;p>E devido ao &lt;code>try {} catch {}&lt;/code> do c√≥digo que tentava carregar essa tela de aviso (sabe aquela famosa &amp;ldquo;&lt;em>por motivos de seguran√ßa seu dispositivo Android bl√° bl√° bl√°&lt;/em>&amp;quot;), era pulada uma das exce√ß√µes poss√≠veis, que era justamente o &lt;em>handle&lt;/em> para a entidade que fazia refer√™ncia para essa &lt;em>activity&lt;/em> na mem√≥ria ser nula, caiu para dentro do limbo das exce√ß√µes gen√©ricas, e o c√≥digo continua sua vida depois daquilo, ent√£o foi literalmente algo similar a isso para contornar esses controles de seguran√ßa:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-javascript" data-lang="javascript">&lt;span style="color:#66d9ef">var&lt;/span> &lt;span style="color:#a6e22e">randomSecurity2&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">Java&lt;/span>.&lt;span style="color:#a6e22e">use&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;???&amp;#39;&lt;/span>);
&lt;span style="color:#a6e22e">randomSecurity2&lt;/span>.&lt;span style="color:#f92672">???&lt;/span>.&lt;span style="color:#a6e22e">implementation&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">function&lt;/span> () {
&lt;span style="color:#a6e22e">console&lt;/span>.&lt;span style="color:#a6e22e">log&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;a ???() called, returning nothing.&amp;#34;&lt;/span>);
}
&lt;span style="color:#a6e22e">randomSecurity2&lt;/span>.&lt;span style="color:#f92672">???&lt;/span>.&lt;span style="color:#a6e22e">implementation&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">function&lt;/span> () {
&lt;span style="color:#a6e22e">console&lt;/span>.&lt;span style="color:#a6e22e">log&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;a ???() called, returning nothing.&amp;#34;&lt;/span>);
}
&lt;span style="color:#75715e">// ??? quer dizer que escondi os nomes para evitar problemas.
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Demorei bastante para chegar aqui, devido a ofusca√ß√£o de c√≥digo do DexGuard, quebrar os decompiladores cl√°ssicos dos execut√°veis Dalvik, colocando caracteres unicode no meio do nome da fun√ß√£o, classe, propriedade etc, fazendo que o decompilador, ao tentar montar o pseudoc√≥digo Java, √† partir do SMALI, caia em um &lt;em>loop&lt;/em> de exce√ß√µes. Ainda bem que podemos criar padr√µes de &lt;em>hooking&lt;/em> baseados nas assinaturas de tipo das fun√ß√µes, e tamb√©m enumerar uma classe por essas mesmas caracter√≠sticas em seu construtor.&lt;/p>
&lt;p>√Ä partir daqui, foi s√≥ programar uma extens√£o para meu proxy para conseguir enviar as requisi√ß√µes para o servidor de &lt;em>backend&lt;/em> com a mesma chave que o cliente original utilizaria para criptografar as &lt;em>payloads&lt;/em> enviadas. Depois de todo esse trabalho, comecei a automatizar as requisi√ß√µes para conseguir, finalmente, fazer o &lt;em>fingerprint&lt;/em> de chaves PIX, e tamb√©m zuar alguns amigos com centenas de transa√ß√µes de um centavo com frases aleat√≥rias do Chuck Norris (caso um dia tiver um domingo tedioso, recomendo utilizar &lt;a href="https://api.chucknorris.io/">essa API&lt;/a> para azucrinar uns amigos).&lt;/p>
&lt;h1 id="shellscript-e-jq-para-come√ßar-a-automa√ß√£o">ShellScript e &lt;code>jq&lt;/code> para come√ßar a automa√ß√£o&lt;/h1>
&lt;p>Depois de fazer todas as muambas necess√°rias para fazer o &lt;em>script&lt;/em> funcionar, temos essa belezura em a√ß√£o:&lt;/p>
&lt;p>&lt;img src="https://i.imgur.com/YdWoOtm.png" alt="PIXMAP funcinando c:">&lt;/p>
&lt;p>E agora era s√≥ passar a chave de algu√©m, e ser feliz:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-sh" data-lang="sh">‚ûú automator ./pixmap.sh --key&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;+5511.......&amp;#34;&lt;/span>
&lt;span style="color:#f92672">[&lt;/span>+&lt;span style="color:#f92672">]&lt;/span> Key +5511......., of type PHONE intel:
&amp;gt; ISPB: &lt;span style="color:#ae81ff">18236120&lt;/span>
&amp;gt; Institution: NU PAGAMENTOS S.A.
&amp;gt; Owner: Jonas Uliana
&amp;gt; Owner Type: PERSONAL
&amp;gt; Document: 000........
&lt;/code>&lt;/pre>&lt;/div>&lt;p>S√≥ substitui meus dados por pontos, assim que alguns bancos responderem adequadamente sobre alguns pontos que notei de bem perigoso na arvore de riscos ao analisar o fluxo transacional do PIX, irei tamb√©m deixar o &lt;em>script&lt;/em>, e uma ferramenta de OSINT (isso √© OSINT? N√£o sei dizer muito bem) decente de fato para azucrinar seus amigos e enriquecer a lista de phishing da empresa.&lt;/p>
&lt;h1 id="minhas-conclus√µes">Minhas conclus√µes&lt;/h1>
&lt;p>Ainda est√° se popularizando, cada vez mais com maior ado√ß√µes e popularidade, mas te todos os testes que fiz em diferentes meios de pagamentos (incluindo bancos, &lt;em>fintechs&lt;/em> e tudo mais), √© vis√≠vel que existe muita falta de maturidade dos modelos de risco ao lidar com fluxos fraudulentos ou an√≥malos dentro do PIX.&lt;/p>
&lt;p>Outro ponto que n√£o sei dizer se √© um risco, ou uma regra de neg√≥cio √† ser seguida do BACEN, √© a permiss√£o de uma conta poder pesquisar centenas de milhares de outras chaves PIX de uma s√≥ vez. Notei que nenhuma institui√ß√£o tinha implementado controles de &lt;em>rate limiting&lt;/em> ou similares, diretamente em suas APIs. A prop√≥sito, foi bem legal notar diversas dessas empresas utilizando GraphQL, eu particularmente prefiro bastante, e acredito que qualquer um que desenvolva &lt;em>frontend&lt;/em> compartilhe desse mesmo sentimento.&lt;/p>
&lt;p>E sobre bloquear o aceite de mensagens no PIX? Bom, acredito que isso pode ser implementado no meio de pagamento, n√£o quero receber mensagens de amea√ßa/marketing ou nada do tipo, ainda que isso implique em ganhar alguns centavos. Meus amigos que ca√≠ram na minha zueira, fizeram 10 reais cada, mas para totalizar essa grana, tomaram 1000 transa√ß√µes PIX com frases do Chuck Norris.&lt;/p></content></item><item><title>Solucionando problemas de sincronismo de requisi√ß√µes em paralelo com SemaphoreSlim</title><link>https://exception.blog/posts/problemas-com-httpclient-resolvidos/</link><pubDate>Wed, 30 Dec 2020 18:21:14 -0300</pubDate><guid>https://exception.blog/posts/problemas-com-httpclient-resolvidos/</guid><description>Dando um push() no problema Um dos desafios que nem com as t√©cnicas mais sombrias de debugging me ajudaram a entender o que meu contexto de requisi√ß√µes HTTP ass√≠ncronos e paralelos estavam retornando uma exce√ß√£o baseada no cancelamento das refer√™ncias das inst√¢ncias dos v√°rios CancellationToken utilizados para construir o cliente das requisi√ß√µes.
Foi uma discuss√£o bem legal com alguns monstros da CLR e at√© mesmo do Roslyn, que com uma paci√™ncia de J√≥, conseguiram ir a fundo na explica√ß√£o sobre o funcionamento da pilha de rede dentro do .</description><content>&lt;h1 id="dando-um-push-no-problema">Dando um &lt;code>push()&lt;/code> no problema&lt;/h1>
&lt;p>Um dos desafios que nem com as t√©cnicas mais sombrias de &lt;em>debugging&lt;/em> me ajudaram a entender o que meu contexto de requisi√ß√µes HTTP ass√≠ncronos e paralelos estavam retornando uma exce√ß√£o baseada no cancelamento das refer√™ncias das inst√¢ncias dos v√°rios &lt;code>CancellationToken&lt;/code> utilizados para construir o cliente das requisi√ß√µes.&lt;/p>
&lt;p>Foi uma discuss√£o bem legal com alguns monstros da CLR e at√© mesmo do Roslyn, que com uma paci√™ncia de J√≥, conseguiram ir a fundo na explica√ß√£o sobre o funcionamento da pilha de rede dentro do .NET, e tamb√©m, sobre a abstra√ß√£o que estava consumindo. No geral, as diversas &lt;em>tasks&lt;/em> que havia emitido, que foram passadas para serem aguardadas sua execu√ß√£o at√© o fim como par√¢metro da fun√ß√£o &lt;code>WhenAll&lt;/code> l√° do bin√°rio &lt;code>System.Runtime.dll&lt;/code>.&lt;/p>
&lt;blockquote>
&lt;p>Para n√£o descer muito o n√≠vel, e deixar tudo de maneira bem entend√≠vel, n√£o vou abranger muito a explica√ß√£o que absorvi, e focar na resolu√ß√£o desse problema relativamente simples.&lt;/p>
&lt;/blockquote>
&lt;h1 id="nem-sempre-√©-tudo-uma-quest√£o-de-alto-n√≠vel">Nem sempre √© tudo uma quest√£o de alto n√≠vel&lt;/h1>
&lt;p>Em contextos de paralelismo com tarefas que consomem muito tempo do processador, ainda que existem outras v√°rias camadas para orquestrarem essas tarefas, desde de o pr√≥prio CPU at√© o sistema operacional e a pr√≥pria &lt;em>stack&lt;/em> de desenvolvimento, cabe a n√≥s implementarmos controles eficazes na orquestra√ß√£o nas nossas pr√≥prias tarefas.&lt;/p>
&lt;p>Especialmente nas linguagens de alt√≠ssimo n√≠vel, que entregam uma abstra√ß√£o &lt;em>muito abstrata - eu ri por dentro aqui -&lt;/em> do que realmente √© uma &lt;em>thread&lt;/em>, devemos ter essa aten√ß√£o dobrada para n√£o cair em um contexto de cancelamento pois o tempo de resposta da aplica√ß√£o para o ambiente onde foi delegada sua execu√ß√£o chegar ao limite.&lt;/p>
&lt;p>Nesse cen√°rio do &lt;code>HttpClientHandler&lt;/code> e do &lt;code>HttpClient&lt;/code> isso fica mais f√°cil de se perceber, mesmo que voc√™ implemente um &lt;em>timeout&lt;/em> na casa dos &lt;code>TimeSpam.FromDays(666)&lt;/code>, se o tempo de execu√ß√£o de qualquer uma das fun√ß√µes ass√≠ncronas do &lt;code>HttpClient&lt;/code>, como a mais utilizada &lt;code>HttpClient.SendAsync(HttpRequestMessage)&lt;/code>, podem retornar um &lt;em>timeout&lt;/em>, mas n√£o da resposta HTTP do servidor, e sim da sua &lt;code>Task&lt;/code> que est√° no limbo do atual contexto de processamento.&lt;/p>
&lt;blockquote>
&lt;p>Vai por mim, evite utilizar fun√ß√µes que podem receber uma sobrecarga de uma inst√¢ncia de &lt;code>CancellationToken&lt;/code>, se ela pode trabalhar com os &lt;em>status&lt;/em> provenientes dessa estrutura, algum motivo tem.&lt;/p>
&lt;/blockquote>
&lt;p>Para simplificar o entendimento de todo esse cen√°rio intang√≠vel, vamos trazer ao c√≥digo uma p√©ssima pr√°tica de programa√ß√£o (que quase me fez desistir do desenvolvimento do &lt;a href="https://github.com/BizarreNULL/httpdoom/">HttpDoom&lt;/a>) relacionada ao paralelismo e assincronicidade de c√≥digo:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-csharp" data-lang="csharp">&lt;span style="color:#66d9ef">using&lt;/span> System;
&lt;span style="color:#66d9ef">using&lt;/span> System.Linq;
&lt;span style="color:#66d9ef">using&lt;/span> System.Net.Http;
&lt;span style="color:#66d9ef">using&lt;/span> System.Threading.Tasks;
&lt;span style="color:#66d9ef">namespace&lt;/span> Exception.Examples
{
&lt;span style="color:#66d9ef">internal&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">Program&lt;/span>
{
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">async&lt;/span> Task Main()
{
&lt;span style="color:#66d9ef">var&lt;/span> tasks = &lt;span style="color:#66d9ef">await&lt;/span> Task.WhenAll(Enumerable.Range(&lt;span style="color:#ae81ff">1&lt;/span>, &lt;span style="color:#ae81ff">5000&lt;/span>)
.Select(&lt;span style="color:#ae81ff">_&lt;/span> =&amp;gt; &lt;span style="color:#66d9ef">new&lt;/span> HttpClient().GetAsync(&lt;span style="color:#e6db74">&amp;#34;https://google.com&amp;#34;&lt;/span>)));
tasks
.Where(t =&amp;gt; &lt;span style="color:#66d9ef">true&lt;/span>)
.ToList()
.ForEach(r =&amp;gt; Console.WriteLine(&lt;span style="color:#e6db74">$&amp;#34;Google answered {r.StatusCode}&amp;#34;&lt;/span>));
}
}
}
&lt;/code>&lt;/pre>&lt;/div>&lt;blockquote>
&lt;p>&lt;strong>Nota&lt;/strong>: &lt;em>Top-level programs&lt;/em> ainda tem algumas coisas bem peculiares para tratar infer√™ncia din√¢mica de tipos e de contextos ass√≠ncronos e paralelos no C# 9, ent√£o vamos no cl√°ssico &lt;em>entrypoint program&lt;/em> mesmo.&lt;/p>
&lt;/blockquote>
&lt;p>Um c√≥digo bem simples, e que - se liga no &lt;em>plot twist&lt;/em> - funciona perfeitamente bem! O motivo de tudo funcionar como deveria, √© que temos implementado somente uma √∫nica responsabilidade dentro da fun√ß√£o paralela e ass√≠ncrona, onde √© iniciado 5000 &lt;code>Task&amp;lt;HttpResponseMessage&amp;gt;&lt;/code> que ser√° aguardada logo no seu &lt;em>enclosure&lt;/em> que √© justamente a pr√≥pria &lt;code>Task.WhenAll&lt;/code>, por ser uma express√£o LINQ, o c√≥digo pode ser um pouco dif√≠cil de ler, mas nada que alguns minutos de leitura n√£o resolva.&lt;/p>
&lt;p>O problema que estamos tentando criar, acontece quando al√©m dessa √∫nica coisa que √© feita (&lt;code>return new HttpClient().GetAsync(&amp;quot;https://google.com&amp;quot;))&lt;/code>, na express√£o an√¥nima da extens√£o &lt;code>Select()&lt;/code> l√° do LINQ), adicionamos alguma fun√ß√£o que freia a execu√ß√£o dessa &lt;em>thread&lt;/em>, por exemplo, escrever na tela informa√ß√µes da requisi√ß√£o conforme s√£o executadas, vamos alterar um pouco o c√≥digo e adicionar algumas fun√ß√µes que fa√ß√£o opera√ß√µes de IO:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-csharp" data-lang="csharp">&lt;span style="color:#75715e">// ...
&lt;/span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">await&lt;/span> Task.WhenAll(Enumerable.Range(&lt;span style="color:#ae81ff">1&lt;/span>, &lt;span style="color:#ae81ff">5000&lt;/span>)
.Select(&lt;span style="color:#66d9ef">async&lt;/span> &lt;span style="color:#ae81ff">_&lt;/span> =&amp;gt;
{
&lt;span style="color:#66d9ef">try&lt;/span>
{
&lt;span style="color:#66d9ef">var&lt;/span> response = &lt;span style="color:#66d9ef">await&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> HttpClient().GetAsync(&lt;span style="color:#e6db74">&amp;#34;https://google.com&amp;#34;&lt;/span>);
Console.Write(&lt;span style="color:#e6db74">$&amp;#34;Remote {response.RequestMessage?.RequestUri} answered {response.StatusCode}, &amp;#34;&lt;/span>);
&lt;span style="color:#66d9ef">var&lt;/span> content = &lt;span style="color:#66d9ef">await&lt;/span> response.Content.ReadAsByteArrayAsync();
Console.WriteLine(&lt;span style="color:#e6db74">$&amp;#34;with a length of {content.Length} byte(s)&amp;#34;&lt;/span>);
&lt;span style="color:#66d9ef">return&lt;/span> response;
}
&lt;span style="color:#66d9ef">catch&lt;/span> (System.Exception e)
{
Console.WriteLine(e.InnerException != &lt;span style="color:#66d9ef">null&lt;/span>
? &lt;span style="color:#e6db74">$&amp;#34;Error: {e.InnerException.Message}&amp;#34;&lt;/span>
: &lt;span style="color:#e6db74">$&amp;#34;Error: {e.Message}&amp;#34;&lt;/span>);
}
}));
&lt;span style="color:#75715e">// ...
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Nesse cen√°rio como temos a intera√ß√£o com opera√ß√µes que causam problemas na hora de serem executadas, e nem por realizarem opera√ß√µes de IO com &lt;code>response.Content.ReadAsByteArrayAsync()&lt;/code> mas sim pela escrita na tela usando &lt;code>System.Console&lt;/code>, que causa um &lt;em>lock&lt;/em> e vira uma bagun√ßa, quem estiver dispon√≠vel, executa essa fun√ß√£o.&lt;/p>
&lt;p>Quando voc√™ executar esse c√≥digo (al√©m de receber um bel√≠ssimo banimento da Google por realizar milhares de requisi√ß√µes em t√£o pouco tempo), vai se deparar com algumas exce√ß√µes de &lt;code>Task&lt;/code> ao inv√©s das inst√¢ncias de classes referentes a pilha de rede do .NET, no caso a famosa mensagem &amp;ldquo;&lt;em>The operation was canceled&lt;/em>&amp;rdquo;.&lt;/p>
&lt;p>E justamente quando receber essa resposta, √© que os problemas do paralelismo come√ßam a perturbar sua sanidade.&lt;/p>
&lt;h1 id="resolvendo-com-uma-boa-sinaliza√ß√£o">Resolvendo com uma boa sinaliza√ß√£o&lt;/h1>
&lt;p>Existem diversas APIs que s√£o fornecidas dentro do CLR para sanar os problemas de paralelismo que correspondem a estes erros, podemos realizar a implementa√ß√£o mais simples que conhe√ßo, que tem pouqu√≠ssimas altera√ß√µes no c√≥digo fonte original da aplica√ß√£o, utilizando &lt;code>SemaphoreSlim&lt;/code> para corrigir esse fiasco.&lt;/p>
&lt;p>Podemos resumir esse elemento de &lt;code>System.Threads&lt;/code> como sendo uma entidade respons√°vel por limitar o n√∫mero de &lt;em>threads&lt;/em> que podem acessar uma &lt;em>pool&lt;/em> de recursos, que √© justamente o que causa &amp;ldquo;&lt;em>The operation was canceled&lt;/em>&amp;rdquo; dentro de uma &lt;code>Task&lt;/code>. Sua implementa√ß√£o √© bem simples, e ele receber por padr√£o um √∫nico argumento correspondente a quantidade m√°xima de &lt;em>threads&lt;/em> que podem ser alocadas para acessar estes recursos:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-c#" data-lang="c#">&lt;span style="color:#66d9ef">var&lt;/span> semaphore = &lt;span style="color:#66d9ef">new&lt;/span> SemaphoreSlim(Environment.ProcessorCount);
&lt;span style="color:#66d9ef">await&lt;/span> Task.WhenAll(Enumerable.Range(&lt;span style="color:#ae81ff">1&lt;/span>, &lt;span style="color:#ae81ff">1000&lt;/span>)
.Select(&lt;span style="color:#66d9ef">async&lt;/span> &lt;span style="color:#ae81ff">_&lt;/span> =&amp;gt;
{
&lt;span style="color:#66d9ef">await&lt;/span> semaphore.WaitAsync();
&lt;span style="color:#66d9ef">try&lt;/span>
{
&lt;span style="color:#66d9ef">var&lt;/span> response = &lt;span style="color:#66d9ef">await&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> HttpClient().GetAsync(&lt;span style="color:#e6db74">&amp;#34;https://zup.com.br&amp;#34;&lt;/span>);
Console.Write(&lt;span style="color:#e6db74">$&amp;#34;Remote {response.RequestMessage?.RequestUri} answered {response.StatusCode}, &amp;#34;&lt;/span>);
&lt;span style="color:#66d9ef">var&lt;/span> content = &lt;span style="color:#66d9ef">await&lt;/span> response.Content.ReadAsByteArrayAsync();
Console.WriteLine(&lt;span style="color:#e6db74">$&amp;#34;with a length of {content.Length} byte(s)&amp;#34;&lt;/span>);
&lt;span style="color:#66d9ef">return&lt;/span> response;
}
&lt;span style="color:#66d9ef">catch&lt;/span> (System.Exception e)
{
Console.WriteLine(e.InnerException != &lt;span style="color:#66d9ef">null&lt;/span>
? &lt;span style="color:#e6db74">$&amp;#34;Error: {e.InnerException.Message}&amp;#34;&lt;/span>
: &lt;span style="color:#e6db74">$&amp;#34;Error: {e.Message}&amp;#34;&lt;/span>);
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span>;
}
&lt;span style="color:#66d9ef">finally&lt;/span>
{
semaphore.Release();
}
}));
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Agora al√©m de podermos controlar o n√∫mero de &lt;em>threads&lt;/em> que ser√£o utilizados para realizar as requisi√ß√µes, tamb√©m n√£o vamos ter problemas de concorr√™ncia ao tentar processar essa &lt;em>pool&lt;/em> de tarefas alocadas no fluxo de execu√ß√£o da aplica√ß√£o.&lt;/p></content></item><item><title>About</title><link>https://exception.blog/about/</link><pubDate>Wed, 16 Dec 2020 17:52:10 -0300</pubDate><guid>https://exception.blog/about/</guid><description>Ol√°, como deve ter percebido, sou o Jojo, escrevo neste blog coisas que gosto, focados em seguran√ßa da informa√ß√£o, linguagens de programa√ß√£o exot√©ricas e um pouco de compiladores/interpretadores de linguagens ainda mais estranhas. Todo o conte√∫do (e o pr√≥prio blog) est√° dispon√≠vel nesse reposit√≥rio esperando seu forks e tamb√©m pull-requests caso quiser publicar algo, bem como corrigir uma cagada ou outra que escrevo aqui.
Para entrar em contato comigo, √© s√≥ pegar minha chave no Keybase, e enviar uma mensagem para jonas dot uliana at passwd dotcom dot br (ou preferencialmente por l√° mesmo).</description><content>&lt;p>Ol√°, como deve ter percebido, sou o Jojo, escrevo neste blog coisas que gosto, focados em seguran√ßa da informa√ß√£o, linguagens de programa√ß√£o exot√©ricas e um pouco de compiladores/interpretadores de linguagens ainda mais estranhas. Todo o conte√∫do (e o pr√≥prio blog) est√° dispon√≠vel nesse &lt;a href="https://github.com/BizarreNULL/exception">reposit√≥rio&lt;/a> esperando seu &lt;em>forks&lt;/em> e tamb√©m &lt;em>pull-requests&lt;/em> caso quiser publicar algo, bem como corrigir uma cagada ou outra que escrevo aqui.&lt;/p>
&lt;p>Para entrar em contato comigo, √© s√≥ pegar minha chave no Keybase, e enviar uma mensagem para &lt;em>jonas &lt;code>dot&lt;/code> uliana &lt;code>at&lt;/code> passwd &lt;code>dot&lt;/code>com &lt;code>dot&lt;/code> br&lt;/em> (ou preferencialmente por l√° mesmo).&lt;/p>
&lt;blockquote>
&lt;p>The content is aimed at Brazilian Portuguese, but some posts are available in English as well.&lt;/p>
&lt;/blockquote></content></item></channel></rss>